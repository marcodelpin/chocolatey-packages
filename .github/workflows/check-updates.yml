name: Check FastStone Updates

on:
  schedule:
    # Esegui ogni giorno alle 8:00 UTC
    - cron: '0 8 * * *'
  workflow_dispatch:  # Permette esecuzione manuale
  push:
    paths:
      - '.github/workflows/check-updates.yml'

permissions:
  contents: read
  issues: write

jobs:
  check-update:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check for FastStone updates
      id: check
      run: |
        # Debug: Show current directory and files
        echo "Current directory: $(pwd)"
        echo "Checking for nuspec file..."
        ls -la packages/faststone-image-viewer/ || echo "Directory not found"
        
        # Estrai versione corrente dal nuspec (prendi solo major.minor)
        if [ -f "packages/faststone-image-viewer/faststone-image-viewer.nuspec" ]; then
          FULL_VERSION=$(grep '<version>' packages/faststone-image-viewer/faststone-image-viewer.nuspec | sed 's/.*<version>\(.*\)<\/version>.*/\1/')
          CURRENT_VERSION=$(echo $FULL_VERSION | cut -d. -f1,2)
          echo "Full version from nuspec: $FULL_VERSION"
          echo "Current version (major.minor): $CURRENT_VERSION"
        else
          echo "ERROR: nuspec file not found!"
          CURRENT_VERSION="0.0"
        fi
        
        # Scarica pagina e estrai nuova versione
        echo "Fetching FastStone website..."
        WEBPAGE=$(curl -s https://www.faststone.org/FSIVDownload.htm)
        echo "Extracting version..."
        NEW_VERSION=$(echo "$WEBPAGE" | grep -oP 'FastStone Image Viewer \K[0-9]+\.[0-9]+' | head -1)
        
        if [ -z "$NEW_VERSION" ]; then
          echo "WARNING: Could not extract version from website"
          NEW_VERSION="0.0"
        fi
        
        echo "Latest version from website: $NEW_VERSION"
        
        # Set outputs
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        
        # Confronta versioni
        if [ "$NEW_VERSION" != "$CURRENT_VERSION" ] && [ "$NEW_VERSION" != "0.0" ] && [ "$CURRENT_VERSION" != "0.0" ]; then
          echo "update_available=true" >> $GITHUB_OUTPUT
          echo "Update is available!"
        else
          echo "update_available=false" >> $GITHUB_OUTPUT
          echo "No update available or error in version detection"
        fi
    
    - name: Show check results
      run: |
        echo "Update available: ${{ steps.check.outputs.update_available }}"
        echo "Current version: ${{ steps.check.outputs.current_version }}"
        echo "New version: ${{ steps.check.outputs.new_version }}"
    
    - name: Create Issue if update available
      if: steps.check.outputs.update_available == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const newVersion = '${{ steps.check.outputs.new_version }}';
          const currentVersion = '${{ steps.check.outputs.current_version }}';
          
          // Cerca se esiste già un issue per questa versione
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'update-available',
            state: 'open'
          });
          
          const existingIssue = issues.data.find(issue => 
            issue.title.includes(newVersion)
          );
          
          if (!existingIssue) {
            // Crea nuovo issue
            const issueBody = `## Aggiornamento Disponibile

FastStone Image Viewer è stato aggiornato dalla versione **${currentVersion}** alla versione **${newVersion}**.

### Azioni richieste:
1. Aggiorna il pacchetto usando:
   \`\`\`powershell
   ./tools/update-package.ps1 -package_name "faststone-image-viewer" -new_version "${newVersion}"
   \`\`\`
2. Testa il pacchetto localmente
3. Commit e push le modifiche
4. Pubblica su Chocolatey

### Link utili:
- [Download page](https://www.faststone.org/FSIVDownload.htm)
- [Changelog](http://www.faststone.org/FSViewerDetail.htm#History)

---
*Questo issue è stato creato automaticamente dal workflow di controllo aggiornamenti.*`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Update: FastStone Image Viewer ${newVersion} disponibile`,
              body: issueBody,
              labels: ['update-available', 'faststone-image-viewer']
            });
            
            console.log(`Issue creato per la versione ${newVersion}`);
          } else {
            console.log(`Issue già esistente per la versione ${newVersion}`);
          }